<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link href=/css/fonts.css rel=stylesheet type=text/css>
<title>PHP Gotcha: Using php://temp</title>
<link rel=stylesheet href=/css/hugo-octopress.css>
<link rel=stylesheet href=/css/fork-awesome.min.css>
<link href=https://alister.github.io/favicon.png rel=icon>
<meta name=description content>
<meta name=keywords content>
<meta name=author content="Alister Bulman">
<meta name=generator content="Hugo 0.87.0">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="PHP Gotcha: Using php://temp">
<meta name=twitter:description content="Just a quicky post, that I hope will save someone (or myself) some head-scratching later.
TLDR: Whenever you fopen('php://temp', $mode) you get a new file.
I found this out when exporting some data from the DB to a spreadsheet/CSV. I was using Yectep\PhpSpreadsheetBundle\Factory (a Symfony bundle around phpoffice/phpspreadsheet) which had a handy method to save the file:
$writer = $this->spreadsheetFactory->createWriter($spreadsheet, '.csv'); $writer->save('php://temp'); From there I would read it back, and upload it to a cloudfiles storage account using FlySystem:">
<meta name=twitter:domain content="alister.github.io">
<meta name=twitter:creator content="@alister_b">
</head>
<body>
<header role=banner>
<hgroup>
<h1><a href=https://alister.github.io/>Professional Blog</a></h1>
<h2>A few things I've been up to</h2>
</hgroup></header>
<nav role=navigation>
<fieldset class=mobile-nav>
<select onchange="location=this.value"><option value>Navigate…</option><option value=https://alister.github.io/blog/>» Blog archive</option><option value=https://alister.github.io/presentations/>» Presentations</option></select>
</fieldset>
<ul class=main-navigation>
<li><a href=https://alister.github.io/blog/ title="Blog archive" rel="noopener noreferrer">Blog archive</a></li>
<li><a href=https://alister.github.io/presentations/ title=Presentations rel="noopener noreferrer">Presentations</a></li>
</ul>
<ul class=subscription>
<a href=https://alister.github.io/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
</ul>
<form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer">
<fieldset role=search>
<input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://alister.github.io/>
</fieldset>
</form>
</nav>
<div id=main>
<div id=content>
<div>
<article class=hentry role=article>
<header>
<p class=meta>Feb 27, 2022
- 2 minute read
</p>
<h1 class=entry-title>
PHP Gotcha: Using php://temp
</h1>
</header>
<div class=entry-content>
<nav id=TableOfContents></nav>
<p>Just a quicky post, that I hope will save someone (or myself) some head-scratching later.</p>
<p><strong>TLDR: Whenever you <code>fopen('php://temp', $mode)</code> you get a new file.</strong></p>
<p>I found this out when exporting some data from the DB to a spreadsheet/CSV. I was using <code>Yectep\PhpSpreadsheetBundle\Factory</code> (a
<a href=https://github.com/eightyknots/phpspreadsheet-bundle/ target=_blank rel=noopener>Symfony bundle</a> around
<a href=https://github.com/PHPOffice/PhpSpreadsheet target=_blank rel=noopener>phpoffice/phpspreadsheet</a>) which had a handy method to save the file:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#268bd2>$writer</span> <span style=color:#719e07>=</span> <span style=color:#268bd2>$this</span><span style=color:#719e07>-&gt;</span>spreadsheetFactory<span style=color:#719e07>-&gt;</span>createWriter(<span style=color:#268bd2>$spreadsheet</span>, <span style=color:#2aa198>&#39;.csv&#39;</span>);
<span style=color:#268bd2>$writer</span><span style=color:#719e07>-&gt;</span>save(<span style=color:#2aa198>&#39;php://temp&#39;</span>);
</code></pre></div><p>From there I would read it back, and upload it to a cloudfiles storage account using
<a href=https://github.com/thephpleague/flysystem target=_blank rel=noopener>FlySystem</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#268bd2>$tempFp</span> <span style=color:#719e07>=</span> fopen(<span style=color:#2aa198>&#39;php://temp&#39;</span>, <span style=color:#2aa198>&#39;rb&#39;</span>);
<span style=color:#268bd2>$wroteStreamOK</span> <span style=color:#719e07>=</span> <span style=color:#268bd2>$this</span><span style=color:#719e07>-&gt;</span>securedFilesystem
    <span style=color:#719e07>-&gt;</span>writeStream(<span style=color:#2aa198>&#39;/path/in/cloudfiles/filename-etc.xlsx&#39;</span>, <span style=color:#268bd2>$tempFp</span>);
</code></pre></div><p>An advantage of using &lsquo;php://temp&rsquo; is that it&rsquo;s usually stored in memory, unless it gets too large (over 2MB, usually), in which case it&rsquo;s automatically saved to disk. Thats one less thing to worry about, right?</p>
<p>Another export-to-CSV was a bit simpler, and so it looped through the database records, and output them directly, using
<a href=https://www.php.net/manual/en/function.fputcsv.php target=_blank rel=noopener><code>fputcsv</code></a> - and it worked great. When I didn&rsquo;t realise was that that didn&rsquo;t open
<a href=https://www.php.net/manual/en/wrappers.php.php#refsect1-wrappers.php-examples target=_blank rel=noopener><code>php://temp</code></a> twice - it opened it directly, saved to it, rewound the file-pointer, and used that file-handle to upload.</p>
<p>With <code>$writer->save('php://temp');</code> it was being opened, and then re-opened <code>$tempFp = fopen('php://temp', 'rb')</code> - so, I got a second, different temporary file - which was empty.</p>
<p>As usual the fix was actually pretty easy, when the underlying problem was recognised.</p>
<ol>
<li>Open the temp file ourselves, & let the spreadsheet bundle use it (<code>$writer->save()</code> happily takes a file-handle/resource directly instead of the filename/path which it must open itself)</li>
<li>Use the same file-handle for the upload (it even does a <code>rewind()</code> itself).</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#586e75>// get the `resource`/file-handle for the temporary stream 
</span><span style=color:#586e75>// we use to save the initial export. We need to be able to 
</span><span style=color:#586e75>// use the identical resource-id to be able to save it later
</span><span style=color:#586e75></span><span style=color:#268bd2>$tempFp</span> <span style=color:#719e07>=</span> fopen(<span style=color:#2aa198>&#39;php://temp&#39;</span>, <span style=color:#2aa198>&#39;rw+b&#39;</span>);
<span style=color:#268bd2>$writer</span><span style=color:#719e07>-&gt;</span>save(<span style=color:#268bd2>$tempFp</span>);

<span style=color:#268bd2>$filepath</span> <span style=color:#719e07>=</span> sprintf(<span style=color:#2aa198>&#39;%s/product_exports_venue%d.%s.%s.csv&#39;</span>, <span style=color:#586e75>/* etc... */</span>);

<span style=color:#586e75>// write the CSV lines to the final file (local directory or the cloud, via Flysystem)
</span><span style=color:#586e75></span><span style=color:#268bd2>$wroteStreamOK</span> <span style=color:#719e07>=</span> <span style=color:#268bd2>$this</span><span style=color:#719e07>-&gt;</span>securedFilesystem<span style=color:#719e07>-&gt;</span>writeStream(<span style=color:#268bd2>$filepath</span>, <span style=color:#268bd2>$tempFp</span>);
</code></pre></div><p>Also see:</p>
<ul>
<li>Stackoverflow:
<a href=https://stackoverflow.com/a/5946711/6216 target=_blank rel=noopener>Having problems reading/writing the php://temp stream</a></li>
<li>PHP.net:
<a href=https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory target=_blank rel=noopener>php://memory and php://temp</a></li>
</ul>
</div>
<footer>
<p class=meta>
<span class="byline author vcard">Posted by <span class=fn>Alister Bulman</span></span>
<time>Feb 27, 2022</time>
<span class=categories>
Tags:
<a class=category href=https://alister.github.io/tags/php>php</a> <a class=category href=https://alister.github.io/tags/gotcha>gotcha</a>
</span>
</p>
<p class=meta>
<a class="basic-alignment left" href=https://alister.github.io/blog/2014/07/12/contributing-to-open-source-can-be-easy/ title="Contributing to open source can be easy">Contributing to open source can be easy</a>
</p>
</footer>
</article>
</div>
<aside class="sidebar thirds">
<section class="first odd">
<h1>Sidebar</h1>
<p>
Re-created with Hugo, Auguest 2021.
</p>
</section>
<ul class=sidebar-nav>
<li class=sidebar-nav-item>
<a target=_blank rel="noopener noreferrer" href=https://github.com/alister title=https://github.com/alister><i class="fa fa-github-square fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://phpscaling.com/ title=https://phpscaling.com/><i class="fa fa-home fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/alister_b/ title=https://twitter.com/alister_b/><i class="fa fa-twitter-square fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/alisterbulman title=https://www.linkedin.com/in/alisterbulman><i class="fa fa-linkedin-square fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://stackoverflow.com/users/6216/alister-bulman title=https://stackoverflow.com/users/6216/alister-bulman><i class="fa fa-stack-overflow-square fa-3x"></i></a>
<a href=https://alister.github.io/index.xml type=application/rss+xml title=RSS><i class="fa fa-rss-square fa-3x"></i></a>
</li>
<a href=https://stackexchange.com/users/4189><img src=https://stackexchange.com/users/flair/4189.png width=208 height=58 alt="profile for Alister Bulman on Stack Exchange, a network of free, community-driven Q&A sites" title="profile for Alister Bulman on Stack Exchange, a network of free, community-driven Q&A sites"></a>
</ul>
<section class=odd>
</section>
<section class=even>
<h1>Recent Posts</h1>
<ul id=recent_posts>
</ul>
</section>
<div class=sidebar-section>
<h3>Tags</h3>
<ul style=list-style-type:none;padding:0;margin:0>
<a href=/tags/dns>dns (2)</a>
<a href=/tags/anti-pattern>anti-pattern (1)</a>
<a href=/tags/capistrano>capistrano (1)</a>
<a href=/tags/contract>contract (1)</a>
<a href=/tags/docker>docker (1)</a>
<a href=/tags/employment>employment (1)</a>
<a href=/tags/faker-extensions>faker-extensions (1)</a>
<a href=/tags/forward3d>forward3d (1)</a>
<a href=/tags/freelance>freelance (1)</a>
<a href=/tags/git>git (1)</a>
<a href=/tags/github>github (1)</a>
<a href=/tags/gotcha>gotcha (1)</a>
<a href=/tags/hwioauthbundle>hwioauthbundle (1)</a>
<a href=/tags/linux>linux (1)</a>
<a href=/tags/mysql>mysql (1)</a>
<a href=/tags/omniauth>omniauth (1)</a>
<a href=/tags/opensource>opensource (1)</a>
<a href=/tags/packagist>packagist (1)</a>
<a href=/tags/php>php (1)</a>
<a href=/tags/phpdox>phpdox (1)</a>
<a href=/tags/phplondon>phplondon (1)</a>
<a href=/tags/presentations>presentations (1)</a>
<a href=/tags/rant>rant (1)</a>
<a href=/tags/repost>repost (1)</a>
<a href=/tags/scaling>scaling (1)</a>
<a href=/tags/wordpress>wordpress (1)</a>
</ul>
</div>
</aside>
</div>
</div>
<footer role=contentinfo>
<p>Copyright &copy; 2022 Alister Bulman -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.
</p>
</footer>
<script>var _gaq=[['_setAccount','UA-37346894-1'],['_trackPageview']];(function(a,b){var c=a.createElement(b),d=a.getElementsByTagName(b)[0];c.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js',d.parentNode.insertBefore(c,d)})(document,'script')</script>
</body>
</html>